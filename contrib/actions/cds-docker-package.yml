version: v1.0
name: CDS_DockerPackage
description: Build image and push it to docker repository
parameters:
  dockerOpts:
    type: string
    description: Docker options, Enter --no-cache --pull if you want for example
  dockerRegistry:
    type: string
    description: Docker Registry. Enter myregistry for build image myregistry/myimage:mytag
  dockerRegistryPassword:
    type: string
    description: Docker Registry Password. Enter password to connect on your docker
      registry.
  dockerRegistryUsername:
    type: string
    description: Docker Registry Username. Enter username to connect on your docker
      registry.
  dockerfileDirectory:
    type: string
    description: Directory which contains your Dockerfile.
  imageName:
    type: string
    description: Name of your docker image, without tag. Enter myimage for build image
      myregistry/myimage:mytag
  imageTag:
    type: string
    default: '{{.cds.version}}'
    description: |-
      Tag og your docker image.
      Enter mytag for build image myregistry/myimage:mytag. {{.cds.version}} is a good tag from CDS.
      You can use many tags: firstTag,SecondTag
      Example : {{.cds.version}},latest
requirements:
- binary: docker
- plugin: plugin-clair
steps:
- script:
  - '#!/bin/bash'
  - set -e
  - ""
  - IMG=`echo {{.imageName}}| tr '[:upper:]' '[:lower:]'`
  - GENTAG="cds{{.cds.version}}"
  - REGISTRY="{{.dockerRegistry}}"
  - USERNAME="{{.dockerRegistryUsername}}"
  - PASSWORD="{{.dockerRegistryPassword}}"
  - ""
  - echo "Building ${REGISTRY}/${IMG}:${GENTAG}"
  - ""
  - cd {{.dockerfileDirectory}}
  - docker build {{.dockerOpts}} -t ${REGISTRY}/${IMG}:${GENTAG} .
  - ""
  - IFS=', ' read -r -a tags <<< "{{.imageTag}}"
  - ""
  - IMG_PUSHED=''
  - ""
  - for t in "${tags[@]}"; do
  - ""
  - "\tset +e"
  - ""
  - "\tif [[ ! -z \"${USERNAME}\" && ! -z \"${PASSWORD}\" && ! -z \"${REGISTRY}\" ]]; then"
  - "\t\techo \"Login to ${REGISTRY}\""
  - "\t\tdocker login -u ${USERNAME} -p ${PASSWORD} ${REGISTRY}"
  - "\tfi"
  - ""
  - "\tTAG=`echo ${t} | sed 's/\\///g'`"
  - "\tdocker tag ${REGISTRY}/${IMG}:${GENTAG} ${REGISTRY}/${IMG}:${TAG}"
  - ""
  - "\techo \"Pushing ${REGISTRY}/${IMG}:${TAG}\""
  - '    IMG_PUSHED="${REGISTRY}/${IMG}:${TAG}"'
  - "\tdocker push ${REGISTRY}/${IMG}:${TAG}"
  - ""
  - "\tif [ $? -ne 0 ]; then"
  - "\t\tset -e"
  - "\t\techo \"/!\\ Error while pushing to repository. Automatic retry in 60s...\""
  - "\t\tsleep 60"
  - "\t\tdocker push ${REGISTRY}/${IMG}:${TAG}"
  - "\tfi"
  - ""
  - "\tset -e"
  - "\techo \" ${REGISTRY}/${IMG}:${TAG} is pushed\""
  - ""
  - "\t#docker rmi -f ${REGISTRY}/${IMG}:${TAG} || true;"
  - done
  - ""
  - IMAGE_ID=`docker images --digests --no-trunc --format "{{.Repository}}:{{.Tag}}
    {{.ID}}" | grep "${REGISTRY}/${IMG}:${GENTAG}" | awk '{print $2}' | head -n 1`
  - IMAGE_DIGEST=`docker images --digests --no-trunc --format "{{.Repository}}:{{.Tag}}
    {{.Digest}}" | grep "${REGISTRY}/${IMG}:${GENTAG}" | awk '{print $2}' | head -n 1`
  - ""
  - echo "ID=$IMAGE_ID"
  - echo "running worker export image.id ${IMAGE_ID}"
  - worker export image.id ${IMAGE_ID}
  - ""
  - echo "DIGEST=$IMAGE_DIGEST"
  - echo "running worker export image.digest ${IMAGE_DIGEST}"
  - worker export image.digest ${IMAGE_DIGEST}
  - ""
  - worker export image.pushed ${IMG_PUSHED}
  - ""
  - '#docker rmi -f ${REGISTRY}/${IMG}:${GENTAG} || true;'
- optional: true
  plugin-clair:
    image: '{{.cds.build.image.pushed}}'
